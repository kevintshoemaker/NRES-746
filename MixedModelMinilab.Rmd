---
title: "Mixed Effects Minilab for NRES746"
author: "Dhurba and Brandi"
date: "November 30, 2016"
output: 
  html_document: 
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


## Mixed-Effect Model Mini-Lab
We are exploring a simple example of a mixed-effect model; the linear mixed model. We are using the lmer function in the lme4 package to fit and analyze our model. We will also use the lattice package.
We are using a Dyestuff data set from the Book "Statistical Methods in Research and Production" by Davies and Goldsmith, which characterizes the variability in chemical processes between batches.

```{r}
###Example:
library(lme4)
library(lattice)
str(Dyestuff) # structure of the data
head(Dyestuff)
summary(Dyestuff) # creat a summary of the data
### fit a model to the Dyestuff data allowing for an overall level of the Yield and for an additive random effect for each level of Batch 
fm1 <- lmer(Yield ~ 1 + (1|Batch), Dyestuff) #linear mixed model fit by REML
print(fm1)
(fm1ML <- lmer(Yield ~ 1 + (1|Batch), Dyestuff, REML = FALSE)) ### linear mixed model fit by maximum likelihood
(fm1ML <- update(fm1, REML = FALSE))# fitting similar model 
summary(fm1a<-lm(Yield~1,Dyestuff)) # 
lm(formula=Yield~1,data=Dyestuff) # to reiterate, the model fm1 corresponds to the linear model
fm1ML <- lmer(Yield ~ 1|Batch, Dyestuff, REML = FALSE, verbose = TRUE) # further assess the fit of the model by matrices and vectors

 pr1<-profile(fm1ML) # profile fuction varying the parameters in a model
 xyplot(pr1,aspect=1.3) # creat profile zeta plot
 confint(pr1,level=0.99) # constructing confidence interval
 # Add absVal=TRUE to your xyplot to visualize the confidene intervals.
 #basically we do xyplot to look at the sensitivity of the model fit to changes in the value of the particular parameters.
 # the ideal profile zeta plot will have a straight line in the region we are interested in,becasue the statistical influence will be more reliable.
 # the pattern of the profile plot is sigmoidal.
 
 splom(pr1) # Another way to look the model fit is to create a profile pairs plots, this not only tells about the sensitivity of the model fit to changes in parameters , it also tells us how the parameters influence each other.
 # the contours corresponds to the confidence regions at particular confidence levels.
 # top 3 panesl  on left represent the original parameters and the panels on the bottom right represent the parameters that have changed. So the contour lines are marginal confidence regions based on the likelihood ratio"50%,80%,90%,95% and 99%"
 
 
```
  

Exercise:
Step1:Repeat the same process for  the "Dyestuff2" data. Observe the str and the summary.
Step2: Fit a model with yield as the response variable and batch as the random effect. Use REML (restricted maximum likelihood) criterion to create a dotplot of the conditional modes of the random effect. 
Step3: Re-fit the model using max likelihood.
Step4: Profile the fitted model and construct 95% profile based confidence intervals on the parameter and also create profile paris plots.
	




