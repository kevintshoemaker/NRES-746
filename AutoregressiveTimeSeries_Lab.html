<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jordan Zabrecky &amp; Sage Ellis" />


<title>Autoregressive Time Series Lab</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NRES 746</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Schedule
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="schedule.html">Course Schedule</a>
    </li>
    <li>
      <a href="Syllabus.pdf">Syllabus</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="INTRO.html">Introduction to NRES 746</a>
    </li>
    <li>
      <a href="LECTURE1.html">Why focus on algorithms?</a>
    </li>
    <li>
      <a href="LECTURE2.html">Working with probabilities</a>
    </li>
    <li>
      <a href="LECTURE3.html">The Virtual Ecologist</a>
    </li>
    <li>
      <a href="LECTURE4.html">Likelihood</a>
    </li>
    <li>
      <a href="LECTURE5.html">Optimization</a>
    </li>
    <li>
      <a href="LECTURE6.html">Bayesian #1: concepts</a>
    </li>
    <li>
      <a href="LECTURE7.html">Bayesian #2: mcmc</a>
    </li>
    <li>
      <a href="LECTURE8.html">Model Selection</a>
    </li>
    <li>
      <a href="LECTURE9.html">Performance Evaluation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Lab exercises
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="LAB_Instructions.html">Instructions for Labs</a>
    </li>
    <li>
      <a href="LAB3demo.html">Lab 3: Likelihood (intro)</a>
    </li>
    <li>
      <a href="LAB5.html">Lab 5: Model selection (optional)</a>
    </li>
    <li>
      <a href="FigureDemo.html">Demo: Figures in R</a>
    </li>
    <li>
      <a href="GIT_tutorial.html">Demo: version control in Git</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Student led topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="GLMM.html">GLMMs</a>
    </li>
    <li>
      <a href="GLMM_Lab.html">GLMMs (lab)</a>
    </li>
    <li>
      <a href="GAMs_Lab.html">GAMs (lab)</a>
    </li>
    <li>
      <a href="Rastering.html">RSFs (raster demo)</a>
    </li>
    <li>
      <a href="RSF_Lab.html">RSFs (lab)</a>
    </li>
    <li>
      <a href="rf2023.html">Random Forest (demo)</a>
    </li>
    <li>
      <a href="rfregression.html">Random Forest (lab)</a>
    </li>
    <li>
      <a href="SpatialRegression.html">Spatial Regression (demo and lab)</a>
    </li>
    <li>
      <a href="Ordination2023.html">Ordination</a>
    </li>
    <li>
      <a href="OrdinationLab2023.html">Ordination (lab)</a>
    </li>
    <li>
      <a href="ts_ar_lecture.html">Time series models</a>
    </li>
    <li>
      <a href="AutoregressiveTimeSeries_Lab.html">Time series models (lab)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Data sets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="TreeData.csv">Tree Data</a>
    </li>
    <li>
      <a href="ReedfrogPred.csv">Reed Frog Predation Data</a>
    </li>
    <li>
      <a href="ReedfrogFuncresp.csv">Reed Frog Func Resp</a>
    </li>
  </ul>
</li>
<li>
  <a href="Links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Autoregressive Time Series Lab</h1>
<h4 class="author">Jordan Zabrecky &amp; Sage Ellis</h4>
<h4 class="date">2023-12-5</h4>

</div>


<p>Welcome to the lab for the Autoregressive Time Series lecture! Below
are three exercises to practice and think about things from the lecture.
Feel free to start with whatever piques your interest most! (Though note
that each question increases in difficulty.) For the submission on
WebCampus, simply turn in a Word document with your answers to the
questions below. You do not have to complete them all! Just turn in what
you are able to get through during the lab period.</p>
<p>You can find the code <a href="AR_Lab.R">here</a> if you don’t want
to copy and paste.</p>
<p>Please feel free to ask questions!</p>
<div id="exercise-1-exploring-acf-and-pacf-plots"
class="section level2">
<h2>Exercise 1 – exploring ACF and PACF plots</h2>
<p>Let’s use the dataset on Lake Washington phytoplankton that we used
during lecture.You may need to install the “MARSS” package if you have
not yet done so.</p>
<pre class="r"><code>library(&quot;MARSS&quot;)

# load the data from the &quot;MARSS&quot; package
data(lakeWAplankton, package = &quot;MARSS&quot;)

# if you do not have the &quot;MARSS&quot; package installed, install it in your console:
# install.packages(&quot;MARSS&quot;)</code></pre>
<p>We will subset part of the data as follows and then turn it into a
time series object.</p>
<pre class="r"><code>phyto &lt;- lakeWAplanktonTrans #Give it a name to keep the original data structure in tact
phyto &lt;- phyto[phyto[,&quot;Year&quot;] &gt; 1975,] #Subset to years greater than 1975 (missing data in early years)

# Note that our data is monthly!
head(phyto)

#Turn into time series object
phyto.ts &lt;- ts(phyto, start = c(1976,1), freq = 12)</code></pre>
<p>Finally we can create an ACF and PACF plot with the time series as
follows:</p>
<pre class="r"><code>#Plot the ACF
acf(phyto.ts[,&quot;Cryptomonas&quot;], na.action = na.pass, las = 1)
#Plot the PCF
pacf(phyto.ts[,&quot;Cryptomonas&quot;], na.action = na.pass, las = 1)</code></pre>
<div id="questions" class="section level4">
<h4>Questions</h4>
<ol style="list-style-type: decimal">
<li>Look at the ACF plot. At what lags do we see autocorrelation in our
data? What measurement of time does each lag step refer to in this
plot?</li>
<li>Look at the PACF plot. At what lags do you see
partial-autocorrelation? What might these lags be telling us about our
data? Can you think of a biological explanation?</li>
</ol>
</div>
</div>
<div id="exercise-2-simple-ar-model" class="section level2">
<h2>Exercise 2 – simple AR model</h2>
<div class="float">
<img src="twobeavers.jpg"
alt="“Architects of Nature” from the Crystal Bridges Art Museum." />
<div class="figcaption">“Architects of Nature” from the Crystal Bridges
Art Museum.</div>
</div>
<p><br> In lecture, we looked at the ACF for a beavers body temperature
and found that there was autocorrelation. Build a simple linear
regression AR model to model beaver body temperature based on previous
temperature. You can also include in their activity, “activ”, at the
current time of measurement or prior time if you would like!</p>
<p>First, load the beaver dataset. It is built into R.</p>
<pre class="r"><code># load the data
data(beavers)</code></pre>
<p>There are two beavers to choose from. Feel free to create ACF and
PACF plots to inform how you make yoru model. Have fun and don’t forget
indexing!</p>
<div id="questions-1" class="section level4">
<h4>Questions</h4>
<ol style="list-style-type: decimal">
<li>Show a screenshot of your code to make the model.</li>
<li>What predictor variables did you decide to include? Did you create
an AR(1) model, AR(2) model, or so on? Why?</li>
</ol>
</div>
</div>
<div id="exercise-3-ar-model-example-in-jags" class="section level2">
<h2>Exercise 3 – AR model example in JAGS</h2>
<p>For our jags example we will be working with an NDVI timeseries. You
can find the data <a href="portal_timeseries.csv">here</a>. <br> For
this exercise you will be writing an AR model into jags. We will provide
most of the code, you will just have to write the likelihood! For now go
ahead and write your likelihood following this model, if you have time
and the desire you can totally play around with other models (but you
will have to adapt priors yourself!).</p>
<p><span class="math display">\[NDVI_{t} \sim Normal(\beta_0 +
\beta_1NDVI_{t-1}+\beta_2Rain_{t-1}, \sigma)\]</span> To do this follow
the code bellow, and alter the jags code in the <code>cat()</code>
section. The rest of the model is specified with priors already!</p>
<pre class="r"><code>#Exercise 3----

##Building Jags Model----

###Data Management and Exploration----

library(jagsUI)

data &lt;-  read.csv(&#39;./Data/portal_timeseries.csv&#39;) #Read in the data, will need to edit to wherever you have it stored

head(data)

plot.ts(data$NDVI) #Plot the time series

#Plot AC plots, anything interesting? :)
acf(data$NDVI)
pacf(data$NDVI) 

#For secret (forecasting) reasons we&#39;re going to cut the last 10 observations out
oos &lt;- data[-(1:(nrow(data)-10)),] #Take the last 100 rows of the data frame and save it as a new dataframe
data.training &lt;- data[(1:(nrow(data)-10)),] #Take out the last 100 rows and the rest of the data is what we will use to make our model

###Build our jags model!----

filename &lt;-  &quot;NDVI_Model.txt&quot;

cat(&quot;

model{

#Likelihood 

for(t in 2:time){ #Loop through the number of observations, we have to start at t=2 because at t=1 there is no t-1 data to pull from!
  ####*******WRITE YOUR LIKELIHOOD HERE*******####
}

#Priors
b0 ~ dnorm(0,0.1) #intercept term - dnorm uses mu and precision (1/var). So prec of 0.1 is a var of 10
b1 ~ dnorm(0,0.1) #slope term for previous month&#39;s NDVI
b2 ~ dnorm(0,0.1) #slope term for previous month&#39;s RAIN

sd ~ dnorm(0,0.1)T(0,) #We&#39;re truncating the prior to be positive

#Derived terms
perc &lt;- pow(sd,-2) #compute precision from stdv. 1/var

}
&quot;,
file = filename)


###Package Data for Jags----

datalist &lt;- list(time = nrow(data.training), NDVI = data.training$NDVI, rain = data.training$rain)

#Specify initial values
#   Each chain needs it&#39;s own initial value for the parameters 
#   So we&#39;ll create a function to generate initial values for us

inits &lt;- function(){
  vals &lt;- list(
    b0 = runif(1,-10,10),
    b1 = runif(1,-10,10), 
    b2 = runif(1,-10,10),
    sd = runif(1,1,10)
  )
  return(vals)
}

inits() #testing
datalist

#Specify what parameters we&#39;re interested in (what do we obtain a joint posterior dist for)
#   What are our free params
params &lt;- c(&quot;b0&quot;, &quot;b1&quot;, &quot;b2&quot;,&quot;sd&quot;)

###Run jags----

nc &lt;- 3 #number of chains
niter &lt;- 10000 #Number of iterations, includes burnin
nb &lt;- 2500 #burnin
thin &lt;- 5 #thining 

#Inits should be function itself, not just one run of it
#N.adapt is the tuning parameter 
mod &lt;- jags(data = datalist, inits = inits, parameters.to.save = params, 
            model.file = filename,
            n.chains = nc, n.adapt=1000, n.iter = niter, n.burnin=nb, n.thin=thin,
            parallel=F)

###Visualize posteriors and assess convergence----
mod #Summary of the model
plot(mod) #Plot trace plots and posterior distributions of our parameters

sims &lt;-  mod$sims.list #Pull out each iteration parameter estimates</code></pre>
<div id="questions-2" class="section level4">
<h4>Questions:</h4>
<ol style="list-style-type: decimal">
<li>Show a screenshot of your code for the likelihood</li>
<li>Did your model converge? How can you tell?</li>
<li>Does there seem to be evidence of an effect of the AR term? Why or
why not?</li>
</ol>
<p>Now just for fun if you’re feeling up to it, work through this code
on how we would use the above model to forecast the last 10 datapoints
we held out.</p>
<pre class="r"><code>#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#If you feel up to it, let&#39;s forecast
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


#We&#39;re going to try and see how well we can forecast those last 10 samples we kept out!

#Step 1: Rebuild the likelikehood

Predictions &lt;- matrix(NA, length(sims$b0), nrow(oos)) #Create a blank matrix to store our predictions
dim(Predictions) # nrow = # of iterations, ncol = years we&#39;re making predictions for (withheld data)

#We have to keep parameter estimates together for each iteration so we need a double for loop

for(p in 1:length(sims$b0)){ #Loops through the number of iterations
  NDVI &lt;- data$NDVI[1] #give it a value to start at
  for(t in 1:nrow(oos)){
    NDVI &lt;- sims$b0[p]+sims$b1[p]*NDVI+sims$b2[p]*oos$rain[t] #Copy the process from what you did in the model
    Predictions[p,t] &lt;- NDVI
  }
}

#Take some summary statistics from our predictions to plot
Mean &lt;- apply(Predictions,2, mean)
UCI &lt;- apply(Predictions,2,quantile, prob = .975)
LCI &lt;- apply(Predictions,2,quantile, prob = .025)

#Now let&#39;s plot our forecast
par(mfrow = c(1,1))
plot(Mean, type = &#39;l&#39;, ylim = c(0.1,0.4))
lines(UCI, lty = 2, col = &#39;steelblue&#39;)
lines(LCI, lty = 2, col = &#39;steelblue&#39;)
points(oos$NDVI, col = &#39;red&#39;) #Actual data

#Then you can do calculate things like RMSE to get a number on how far our predictions are to the observed data</code></pre>
<p>And now you’ve successfully made a forecast based on your AR(1)
model!</p>
</div>
<div id="bonus-question" class="section level4">
<h4>Bonus Question:</h4>
<ol style="list-style-type: decimal">
<li>Think about why the error of our forecast might get bigger over the
time we’re predicting, why might this be?</li>
</ol>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
