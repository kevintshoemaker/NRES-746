<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>GAMs Lab</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">NRES 746</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Schedule
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="schedule.html">Course Schedule</a>
    </li>
    <li>
      <a href="Syllabus.pdf">Syllabus</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="INTRO.html">Introduction to NRES 746</a>
    </li>
    <li>
      <a href="LECTURE1.html">Why focus on algorithms?</a>
    </li>
    <li>
      <a href="LECTURE2.html">Working with probabilities</a>
    </li>
    <li>
      <a href="LECTURE3.html">The Virtual Ecologist</a>
    </li>
    <li>
      <a href="LECTURE4.html">Likelihood</a>
    </li>
    <li>
      <a href="LECTURE5.html">Optimization</a>
    </li>
    <li>
      <a href="LECTURE6.html">Bayesian #1: concepts</a>
    </li>
    <li>
      <a href="LECTURE7.html">Bayesian #2: mcmc</a>
    </li>
    <li>
      <a href="LECTURE8.html">Model Selection</a>
    </li>
    <li>
      <a href="LECTURE9.html">Performance Evaluation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Lab exercises
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="LAB_Instructions.html">Instructions for Labs</a>
    </li>
    <li>
      <a href="LAB3demo.html">Lab 3: Likelihood (intro)</a>
    </li>
    <li>
      <a href="LAB5.html">Lab 5: Model selection (optional)</a>
    </li>
    <li>
      <a href="FigureDemo.html">Demo: Figures in R</a>
    </li>
    <li>
      <a href="GIT_tutorial.html">Demo: version control in Git</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Student led topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="GLMM.html">GLMMs</a>
    </li>
    <li>
      <a href="GAMs_Lab.html">GAMs (lab)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Data sets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="TreeData.csv">Tree Data</a>
    </li>
    <li>
      <a href="ReedfrogPred.csv">Reed Frog Predation Data</a>
    </li>
    <li>
      <a href="ReedfrogFuncresp.csv">Reed Frog Func Resp</a>
    </li>
  </ul>
</li>
<li>
  <a href="Links.html">Links</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">GAMs Lab</h1>

</div>


<p>Here’s the code if you’d like to follow along: <a
href="GAMs_Lab.R">GAMs Lab</a></p>
<p>So, now that you’ve learned about the theory behind GAMs and seen
some applications, it’s time for you to build your own! First, we’ll
quickly recap how to use the gam function in mgcv. Then, we’ll need to
go over some of the options you have when building a GAM in the mgcv
package: the different spline options, how to have two (or more)
predictor variables interact in your model, and including categorical
data as predictor variables in your model.</p>
<div id="the-gam-function" class="section level1">
<h1>The GAM Function</h1>
<p>When using the GAM function in mgcv, you have two required arguments:
formula and data. The data argument is straightforward, just input your
dataframe. The formula argument is a little more complex, but is similar
to the formula argument used in the glm function. The most important
difference is that you’ll put a smooth on one or more of your predictor
variables, as shown below:</p>
<pre class="r"><code>library(mgcv) #load the mgcv package</code></pre>
<pre><code>## Loading required package: nlme</code></pre>
<pre><code>## This is mgcv 1.8-42. For overview type &#39;help(&quot;mgcv-package&quot;)&#39;.</code></pre>
<pre class="r"><code>mcycle &lt;- MASS::mcycle #pull in some data; we&#39;ll be using this dataset for this example but not the lab

?gam #take a look at the documentation page for the function to see what you can specify - it&#39;s a lot!</code></pre>
<pre><code>## starting httpd help server ...</code></pre>
<pre><code>##  done</code></pre>
<pre class="r"><code>#now we&#39;ll go ahead and fit our spline using the most basic call of the function possible
gam_mod &lt;- gam(accel ~ s(times), data = mcycle) #here, we predict acceleration based on a smooth, nonlinear function of times

plot(gam_mod, residuals = T, pch = 1) #setting residuals=T will include the CIs on the plot</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Not too bad to fit! You should notice that the big difference between
this and a glm was the “s() wrapped around our predictor variable. Doing
this fits a smooth spline to our data, making our model a GAM!</p>
<p>If we want to see the basis functions for our spline, we can do so
using the coef function:</p>
<pre class="r"><code>coef(gam_mod)</code></pre>
<pre><code>## (Intercept)  s(times).1  s(times).2  s(times).3  s(times).4  s(times).5 
##  -25.545865  -63.718008   43.475644 -110.350132  -22.181006   35.034423 
##  s(times).6  s(times).7  s(times).8  s(times).9 
##   93.176458   -9.283018 -111.661472   17.603782</code></pre>
<p>Lastly, we can control the amount of smoothing done by our spline in
a couple of ways. You can set a fixed smoothing parameter using the
argument sp, either inside the smooth function itself or as another
argument. Alternatively, you can tell R to chose a smoothing parameter
using restricted maximum likelihood.</p>
<pre class="r"><code>gam_mod_s1 &lt;- gam(accel ~ s(times), data = mcycle, sp = 0.1) #smoothing by setting a fixed smoothing parameter
gam_mod_s2 &lt;- gam(accel ~ s(times), data = mcycle, method = &quot;REML&quot;)

par(mfrow = c(2, 1)) #we&#39;ll plot both models side by side to compare
plot(gam_mod_s1, residuals = TRUE, pch = 1)
plot(gam_mod_s2, residuals = TRUE, pch = 1)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>As you can see, a smoothing factor of 0.1 was too high for our data
in this case. Finding a good smoothing factor can be a lot of trial and
error, I recommend you play around with it some and see what tends to
work best!</p>
</div>
<div id="types-of-splines-in-the-mgcv-package" class="section level1">
<h1>Types of Splines in the mgcv Package</h1>
<p>That was the default spline option, but there’s lots of options for
splines in this package. We won’t go over all of them here, but you can
read about the rest of them <a
href="https://www.rdocumentation.org/packages/mgcv/versions/1.9-0/topics/smooth.terms">here
on the R documentation page for smooth.terms</a>. We also won’t be
getting into the full mathematical theory behind each spline type, but
we’ll present the basics; one of the key differences not discussed here
is how each spline type penalizes error, which is also outlined in the
documentation.</p>
<div id="thin-plate-splines" class="section level3">
<h3>Thin-Plate Splines</h3>
<p>A thin-plate regression spline is the default spline in the mgcv
package, so it’s what was fit in the example above. They don’t have
“knots” like we talked about in lecture, they use an eigen-decomposition
to determine where to split the data instead.</p>
<p>To specify a thin-plate spline, use the argument ‘bs=“tp”’:</p>
<pre class="r"><code>gam_mod_tp &lt;- gam(accel ~ s(times, bs=&quot;tp&quot;), data = mcycle)
plot(gam_mod_tp, residuals = T, pch = 1)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
<div id="cubic-regression-splines" class="section level3">
<h3>Cubic Regression Splines</h3>
<p>Cubic regression splines are relatively common, and less
theoretically complex than thin-plate splines. They are made up of cubic
basis functions defined by knots spread evenly through the covariate
values.</p>
<p>To specify a cubic regression spline, use the argument ‘bs=“cr”’:</p>
<pre class="r"><code>gam_mod_cr &lt;- gam(accel ~ s(times, bs=&quot;cr&quot;), data = mcycle)
plot(gam_mod_cr, residuals = T, pch = 1)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>#you can leave the knots argument blank, as above, or specify it:
gam_mod_cr_3 &lt;- gam(accel ~ s(times, bs=&quot;cr&quot;,k=3), data = mcycle) #(in this example this is clearly a terrible choice of number of knots)
plot(gam_mod_cr_3, residuals = T, pch=1)  </code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
</div>
<div id="p-splines" class="section level3">
<h3>P-splines</h3>
<p>P-splines are also known as smoothing splines - their derivatives are
penalized to enforce smoothness. P-splines can function better than
other types of splines (such as cubic splines or B-splines, which
they’re based on) if the knots are not evenly spaced. They are also
generally flexible, which is good if the smooth is messy. However, in
most cases the thin-plane or cubic regression smooths will yield a lower
mean squared error for your model.</p>
<p>To specify a P-spline, use the argument ‘bs=“ps”’:</p>
<pre class="r"><code>gam_mod_ps &lt;- gam(accel ~ s(times, bs=&quot;ps&quot;), data = mcycle)
plot(gam_mod_ps, residuals = T, pch = 1)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>You may have noticed that all three of the above plots look pretty
similar on the main spline fit, but the CI varies a bit. Which type of
spline is best depends on the data, but the authors of the mgcv package
note that thin-plate splines typically perform the best, followed by the
penalized cubic regression splines and then p-splines.</p>
</div>
<div id="other-types-of-splines" class="section level3">
<h3>Other Types of Splines</h3>
<p>We chose the above classes of splines to cover because they generally
perform well in model fitting and are more common, but mgcv includes
options for a range of other splines:</p>
<ul>
<li>Duchon splines (generalized versions of thin-plate splines)</li>
<li>Splines on the sphere (popular for data sampled across the globe,
with latitude and longitude as arguments)</li>
<li>B-splines (relatively common)</li>
<li>Random effects (can represent the parametric interactions of
multiple variables)</li>
<li>Markov random fields (popular for discrete contiguous geographic
units)</li>
<li>Gaussian process smooths</li>
<li>Soap film smooths</li>
<li>Adaptive smoothers</li>
<li>Factor smooth interactions</li>
<li>Random factor smooth interactions</li>
<li>A custom smooth! (using the function <a
href="https://rdocumentation.org/packages/mgcv/versions/1.9-0/topics/smooth.construct">custom.smooth</a>)</li>
</ul>
</div>
</div>
<div id="interacting-variables" class="section level1">
<h1>Interacting Variables</h1>
<p>All this is great for fitting splines with one or more predictor
variables acting independently, but how do we incorporate interactions
between variables in our model? We’ll use a new dataset on metal
concentrations in different soil areas to answer this question.</p>
<p>For variables on the same scale, we can use the same smooth spline
function as before, wrapping our variables with s(). This is often
useful for coordinate data.</p>
<pre class="r"><code>library(sp)</code></pre>
<pre><code>## The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
## which was just loaded, will retire in October 2023.
## Please refer to R-spatial evolution reports for details, especially
## https://r-spatial.org/r/2023/05/15/evolution4.html.
## It may be desirable to make the sf package available;
## package maintainers should consider adding sf to Suggests:.
## The sp package is now running under evolution status 2
##      (status 2 uses the sf package in place of rgdal)</code></pre>
<pre class="r"><code>data(meuse, package=&quot;sp&quot;) #load in and inspect dataset
head(meuse)</code></pre>
<pre><code>##        x      y cadmium copper lead zinc  elev       dist   om ffreq soil lime
## 1 181072 333611    11.7     85  299 1022 7.909 0.00135803 13.6     1    1    1
## 2 181025 333558     8.6     81  277 1141 6.983 0.01222430 14.0     1    1    1
## 3 181165 333537     6.5     68  199  640 7.800 0.10302900 13.0     1    1    1
## 4 181298 333484     2.6     81  116  257 7.655 0.19009400  8.0     1    2    0
## 5 181307 333330     2.8     48  117  269 7.480 0.27709000  8.7     1    2    0
## 6 181390 333260     3.0     61  137  281 7.791 0.36406700  7.8     1    2    0
##   landuse dist.m
## 1      Ah     50
## 2      Ah     30
## 3      Ah    150
## 4      Ga    270
## 5      Ah    380
## 6      Ga    470</code></pre>
<pre class="r"><code>mod &lt;- gam(cadmium ~ s(x, y) + s(elev), #first, we fit a model where x and y coordinates interact directly and
           data = meuse, method = &quot;REML&quot;) #elevation is separate
plot(mod)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-7-1.png" width="672" /><img src="GAMs_Lab_files/figure-html/unnamed-chunk-7-2.png" width="672" /></p>
<p>However, often our interacting variables won’t be on the same scale.
We can deal with this using a tensor spline, te().</p>
<pre class="r"><code>tensor_mod &lt;- gam(cadmium ~ te(x, y, elev),  #this model allows x and y coordinates and elevation to interact 
                  data = meuse, method = &quot;REML&quot;)  #despite being on different scales
plot(tensor_mod)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>If you want to separate out independent and interacting effects of
variables, you can use a tensor interaction ti(). Here, we’ll fit a
regular smooth for the variables at first and then add a tensor
interaction term.</p>
<pre class="r"><code>tensor_mod2 &lt;- gam(cadmium ~ s(x, y) + s(elev) + ti(x, y, elev), #notice how two regular smooths are fit in addition to
                   data = meuse, method = &quot;REML&quot;)                   #the tensor interaction</code></pre>
<p>Both tensor splines and tensor interactions allow you to specify the
different types of spline fits (e.g. cubic regression, P-spline, etc.)
that we discussed above. They’re very useful overall, and will
definitely come in handy during this lab!</p>
</div>
<div id="including-categorical-data" class="section level1">
<h1>Including Categorical Data</h1>
<p>Our last topic for this mini-lecture is how to include categorical
data in our GAMs. Simply including a categorical variable is
straightforward and similar to how it’s done in a GLM - just add the
variable to the model formula without a smooth. When done like this,
you’ll have a different intercept for each category of land use.</p>
<pre class="r"><code>mod2da &lt;- gam(cadmium ~ s(dist)+landuse, 
              data = meuse, method = &quot;REML&quot;)</code></pre>
<p>However, if you want different smooths depending on the values of
your categorical variables, you’ll have to include them differently.
Categorical variables can be included inside the smooth functions to
easily achieve this.</p>
<pre class="r"><code>mod_sep &lt;- gam(copper ~ s(dist, by = landuse) + landuse, #notice how landuse is included both inside and outside the smooth
               data = meuse, method = &quot;REML&quot;) #this gives us different smooths and different intercepts for each value of                                                     the variable
summary(mod_sep)</code></pre>
<pre><code>## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## copper ~ s(dist, by = landuse) + landuse
## 
## Parametric coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)   20.115     46.338   0.434    0.665
## landuseAb     15.674     46.609   0.336    0.737
## landuseAg      6.670     46.827   0.142    0.887
## landuseAh     18.137     46.398   0.391    0.697
## landuseAm     13.364     46.441   0.288    0.774
## landuseB       0.825     62.981   0.013    0.990
## landuseBw     18.909     46.758   0.404    0.687
## landuseDEN     0.000      0.000     NaN      NaN
## landuseFh      4.885    155.445   0.031    0.975
## landuseFw     18.578     46.573   0.399    0.691
## landuseGa    122.541     99.226   1.235    0.219
## landuseSPO     1.885    146.517   0.013    0.990
## landuseSTA     3.261     49.284   0.066    0.947
## landuseTv      4.885    134.316   0.036    0.971
## landuseW      18.917     46.444   0.407    0.684
## 
## Approximate significance of smooth terms:
##                           edf     Ref.df      F  p-value    
## s(dist):landuseAa   1.000e+00  1.000e+00  0.000  0.98367    
## s(dist):landuseAb   1.000e+00  1.000e+00  1.672  0.19845    
## s(dist):landuseAg   1.000e+00  1.000e+00  0.442  0.50765    
## s(dist):landuseAh   2.524e+00  3.113e+00  8.725 2.28e-05 ***
## s(dist):landuseAm   1.000e+00  1.000e+00  6.802  0.01025 *  
## s(dist):landuseB    1.000e+00  1.000e+00  0.023  0.87892    
## s(dist):landuseBw   1.000e+00  1.000e+00  0.047  0.82898    
## s(dist):landuseDEN  1.000e+00  1.000e+00  0.042  0.83865    
## s(dist):landuseFh   8.905e-16  8.905e-16  0.000  1.00000    
## s(dist):landuseFw   2.696e+00  3.304e+00  5.292  0.00134 ** 
## s(dist):landuseGa   1.882e+00  1.986e+00  0.654  0.49571    
## s(dist):landuseSPO  7.012e-16  7.012e-16  0.000  1.00000    
## s(dist):landuseSTA  1.000e+00  1.000e+00  0.005  0.94455    
## s(dist):landuseTv  -6.791e-17 -6.791e-17  0.000  1.00000    
## s(dist):landuseW    4.009e+00  4.814e+00 32.861  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Rank: 146/150
## R-sq.(adj) =  0.634   Deviance explained = 71.1%
## -REML = 532.81  Scale est. = 199.48    n = 154</code></pre>
<pre class="r"><code>plot(mod_sep,pages=2)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-11-1.png" width="672" /><img src="GAMs_Lab_files/figure-html/unnamed-chunk-11-2.png" width="672" /></p>
<p>As you can see this generates a lot of graphs of our model, one for
each value of landuse.</p>
</div>
<div id="model-selection" class="section level1">
<h1>Model Selection</h1>
<p>As with any other model, you will often build multiple GAMs and need
to pick the best one, but how? There are a couple of different ways to
do this, including comparing likelihoods/the likelihood ratio test and
calculating AIC. We’ll quickly go over how to do both of these for
GAMs.</p>
<p><strong>Important:</strong> When performing model selection, you
should (almost always) use an ML estimate instead of an REML estimate.
When you are comparing models with different fixed effects, in a
likelihood ratio test or in some other way, you should always use ML
instead of REML. Once you have selected the best model, you can then go
back and use REML to get a new, typically more accurate, parameter
estimate; in this situation, REML is better because it typically returns
a less biased estimate of the variance than ML. To do this, simply use
“ML” as the method argument in your model, as below:</p>
<pre class="r"><code>mod2d &lt;- gam(cadmium ~ s(x,y), data = meuse, method = &quot;ML&quot;)</code></pre>
<p>Now, say we want to perform a likelihood ratio test between this
model and a model that includes elevation (which we can do because
they’re nested!). We can build our elevation model, also using the ML
method, and then perform a likelihood ratio test (here we’re using a
canned one from a package because actually extracting the ML value from
the model is a bit tedious).</p>
<pre class="r"><code>mod2d_elev &lt;- gam(cadmium ~ s(x, y) + s(elev), 
           data = meuse, method = &quot;ML&quot;)

library(lmtest) #we need to load this package to do the likelihood ratio test</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre class="r"><code>lrtest(mod2d_elev,mod2d) </code></pre>
<pre><code>## Likelihood ratio test
## 
## Model 1: cadmium ~ s(x, y) + s(elev)
## Model 2: cadmium ~ s(x, y)
##      #Df  LogLik     Df  Chisq Pr(&gt;Chisq)    
## 1 30.486 -306.58                             
## 2 26.345 -329.36 -4.141 45.568  3.029e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>A significant p-value from the likelihood ratio test indicates that
the full model fits the data better than the reduced model, and we
should therefore use the full model (which contains elevation).</p>
<p>In most cases, we won’t be comparing models that are nested. In this
case, we want to compare the AIC values of two models that incorporate
the same predictor variables using different spline types. This can
easily be done using the AIC() function on our model(s).</p>
<pre class="r"><code>mod &lt;- gam(cadmium ~ s(x, y) + s(elev), #this model considers elevation separately from x and y
           data = meuse, method = &quot;ML&quot;)

tensor_mod &lt;- gam(cadmium ~ te(x, y, elev), #this model considers elevation interacting with x and y
                  data = meuse, method = &quot;ML&quot;)

AIC(mod,tensor_mod) # we can calculate both aic values simultaneously to make comparison even easier!</code></pre>
<pre><code>##                  df      AIC
## mod        30.48630 674.1282
## tensor_mod 41.22866 649.6274</code></pre>
<p>The AIC from the tensor model is much lower than the AIC from the
model considering elevation separate from x- and y-coordinates.
Therefore, we can confidently say that the tensor spline model is
better!</p>
<p>Overall, model selection in GAMs is pretty straight-forward and based
on a lot of the principles we discussed in class. Just make sure you use
ML instead of REML when picking models to compare and you’re good to
go!</p>
</div>
<div id="other-important-notes" class="section level1">
<h1>Other Important Notes</h1>
<p>Those are the main things you need to know to start fitting GAMs in
R, but here are a couple other functions you might find useful during
lab (or when fitting GAMs in your own work):</p>
<ul>
<li>gam.check() - will return a significant p-value for any smooth that
doesn’t have enough basis functions (i.e. not enough knots)</li>
<li>concurvity() - will check how determined smooths are by other
smooths, AKA how independent/dependent your predictors are. A lower
concurvity means a smooth/predictor is more independent.</li>
<li>vis.gam(se=x) - allows you to add confidence intervals to your GAM
plots by changing the x argument. vis.gam() has lots of other cool
plotting options for your data as well, which can be useful when your
GAMs have many dimensions.</li>
</ul>
<p>Also, <a href="https://noamross.github.io/gams-in-r-course/">this
github tutorial</a> is immensely useful for walking through the basic
options for GAMs in mgcv in more depth than we do here. Much of the
material for this mini-lecture was adapted from it, and I highly
recommend it for anyone who needs to use GAMs in their own research.</p>
</div>
<div id="lab-exercise" class="section level1">
<h1>Lab Exercise</h1>
<p>Now that we’ve been over all that, it’s time for the mini-lab! For
this lab, we are providing you with (simulated) data about three species
of garter snakes: <em>T. atratus</em>, <em>T. elegans</em>, and <em>T.
couchii</em>. You can find the data <a href="GAMs_SnakeSpeeds.csv">at
this link</a>. Using this data, we would like you to build a GAM that
models snake speed as a function of some (or all) of the predictor
variables in the file.</p>
<p>The data file contains the following information about each
individual:</p>
<ul>
<li>Species (<em>atratus</em>, <em>elegans</em>, or
<em>couchii</em>)</li>
<li>Age (“Adult” or “Juvenile”)</li>
<li>SVL (Snout-Vent Length, the total length of the snake)</li>
<li>Mass (mass of the snake)</li>
<li>Tail (length of the snake’s tail (yes, snakes have tails: they begin
where the ribs end))</li>
<li>Lat (latitude at which the snake was collected)</li>
<li>Long (longitude at which the snake was collected)</li>
<li>MAMU (mass-adjusted mouse units, this measures the snake’s
resistance to TTX, a toxin that binds sodium channels. Resistance
(mostly) comes from sodium channel mutations, which could affect muscle
action and therefore snake speed…)</li>
<li>Speed (what we want to predict!)</li>
</ul>
<p>You can assume that SVL, Mass, and Tail are on the same scale, as are
Latitude and Longitude. ALl other variables are on different scales and
must be treated accordingly in your model.</p>
<div id="part-1-examine-your-data" class="section level3">
<h3>Part 1: Examine Your Data</h3>
<p>First, take a few minutes to examine your data, plotting different
variables to see if they might be correlated and if so in which
direction. If variables are sufficiently correlated, including both of
them in your model might not be worth the extra complexity it
introduces.</p>
<p><em>Hint:</em> Start by just using the plot function to plot
variables from the data against as each other (for example, put Speed on
the y-axis and Latitude on the x-axis). Alternatively, you can use the
cor() function to generate a matrix of covariants for all the items in
your data, <strong>but</strong> this function does not work for
categorical data - you’ll have to exclude those columns of the
dataframe.</p>
<p><strong>Question:</strong> What predictor variables seem correlated
with one another? What predictor variables seem correlated with speed?
Given these correlations, what variables do you think you should include
in your GAM? Write your answer(s) in a Word doc for submission.</p>
</div>
<div id="part-2-build-your-gam" class="section level3">
<h3>Part 2: Build Your GAM</h3>
<p>Now that you’ve examined the data and have an idea of which variables
you want to include in your model, it’s time to make a GAM! Refer to the
earlier parts of this tutorial as much as needed, and feel free to ask
questions. Again, we recommend you make multiple GAMs and then choose
the one with the best fit, starting with the one you proposed in the
earlier question. There’s a decent chance that won’t be the best model
possible, so it’s worth playing around and seeing what you can make
happen. Remember to use ML when building your models to compare!</p>
<p><em>Hint:</em> For model comparison, use the summary() function on
your GAM object. It will give you a list of the different predictor
variables and the likelihood (in the form of a p-value, though you can’t
interpret it quite like a normal p-value) that they affect the response
variable (speed). It will also return values for R-squared; the ML
(maximum likelihood) or REML (restricted maximum likelihood), depending
on which you chose while building your model; and the deviance explained
by your model. You can also perform a likelihood ratio test using the ML
values, or calculate AIC (revisit “Model Selection” above to review how
to do this).</p>
<p><strong>Question:</strong> Which model ended up being the best fit
for the data? Is it the one you predicted originally? Include your
model-generating function in your answer, either as a screenshot of R or
by typing it out.</p>
<p><strong>Bonus activity:</strong> Plot your model’s predicted data
over the observed data to confirm the predictions are as good (or bad)
as the R-squared value suggests. You can do this using your GAM object
and the vis.gam() and points() functions, as below:</p>
<pre class="r"><code>mod2d &lt;- gam(cadmium ~ s(x,y), data = meuse, method = &quot;REML&quot;)

vis.gam(mod2d, view = c(&quot;x&quot;, &quot;y&quot;), #the view argument allows you to define which variables make the axes
        plot.type = &quot;contour&quot;, too.far = 0.05)
points(meuse) 

#you may need to specify which parts of the data to pass to points, as below (sometimes it just picks the first two columns which is an issue if that&#39;s not the part of your model you&#39;re plotting)
points(meuse$x,meuse$y)</code></pre>
<p><img src="GAMs_Lab_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
