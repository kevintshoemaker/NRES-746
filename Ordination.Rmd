---
title: "Multivariate Ordination"
author: "Cody Reed and Gareth Blakemore"
output: 
  html_document: 
    theme: cerulean
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, echo=FALSE}
#setwd("/Users/codyreed/Dropbox/Grad School/Adv Analysis in Natural Resources/Ordination")

```

Ordination thrives on complex networks of intercorrelations by simplifying multivariate data into low dimensional graphics. In doing so, it helps us focus on important dimensions and avoid misinterpreting noise in the data. This can be useful for pattern detection (often used for species composition) and hypothesis generation. 

Ordination can also be used to examine relationships between enviornmental gradients and community structure. 


Ordination models can be divied into two categories, indirect and direct gradient analyses. 

#### Indirect Gradient Analysis
Indirect gradient analysis seeks to interpret multivariate environmental space as the species sees it by positioning items according to covariation and association among species or plots. In an indirect gradient analysis of plots or sample sites, points that appear closer to each other share similar specis composition. An indirect gradient analysis of species, on the other hand, reveals species that then to co-occur in the landscape. 

Methods:
- Bray-Curtis (Polar) Ordination
- Principal Coordinate Analysis (PCA)
- Correspondence Analysis (CA)
- Detrended Correspondence Analysis (DCA)
- Nonmetric Dimensional Scaling (NMDS)

###Overview of Indirect Gradient Analysis Methods
#### Bray-Curtis (Polar) Ordination

The Bray-Curtis methos was develope in 1957 by Bray & Curtis as a fast and easy method of multivariate analysis. It was originally designed so anyone could do it with no more than a calculator and compass. The method is based on Euclidean geometry and arranged points in reference to endpoints or "poles". It is not used much anymore but, because of its simplicity, it's useful for explaining the basics of ordination

####Steps for calculating Bray-Curtis Ordination
(Adapted from B. McCune, Grace, J, Urban, D. *Analysis of Ecological Communities.* Vol, 28. 2002.)

**1. Construct primary data matrix (plots x species)**

**2. Calculate dissimilarity matrix (distances between all pairs of N points)**
There are many methods that can be used to calculate dissimilarity matrix. Bray-Curtis dissimilarity matrix and Soensen similarity index are two that are commonly used

Bray-Curtis dissimilarity
{\displaystyle BC_{ij}=1-{\frac {2C_{ij}}{S_{i}+S_{j}}}}
Where *C* is the sum of the values found at both sites and *S* is the total number of species counted at each site

**3. Select most distant points as endpoints**

**4. Calculate position of each point on the axis between reference points**

**5. Calculate residual distance between points**

**6. Calculate residual sum of squares **and compare with original sum of squares to determine percent of original variance explained by each axis.

**7. Substitute residual matrix for dissimilarity matrix and construct successive axes**

**8. Repeat steps 3-6 for additional axes**

![](http://ordination.okstate.edu/overvi4.gif)


The result is an ordination of points were similar sites or species are grouped together.

Useful for:
- Heuristic purposes (i.e. extracting ecologial gradients)
- Non-linear relationsips among species

Issues:
- Best for heuristic purposes
- The simplicity of the method is not necessary with modern computing power

####Principal Component Analysis (PCA)
PCA was develped by Pearson in 1901 as data reduction method used to seek the strongest relationships in multivariate data. It seeks the strongest linear correlation structure and the results produce the amount of variation explaiend by each axis (eigenvalues)

Useful for:
- Data with approximately linear relationships between variables
- Distilling suites of intercorrelated variables
- Ordinating homogenous community data sets
- Data sets that do not include null variables

Issues:
- Distortion of heterogenous data sets ("arch effect")
- Only uses Euclidean distances
- Results are influenced by outliers
- Requires linear relationships & multivariate normality

####Principal Coordinates Analysis (PCoA)
PCoA is a more general form of PCA and was developed in an attempt to resolve some of the issues with PCA. It can accomodate non-Euclidean distances but suffers from many of other issues that PCA does.

####Correspondence Analysis (CA)
CA uses repeaded weighted averaging ("reciprocal averaging") of site scores to yield species scores and visa versa. With CA, axes are rotated through ordination space to maximize correspondence between speices and the sample space. 

Useful for:
- Abundance data
- Identifing species distribution along an environmental gradient

Issues:
- Second and subsequent axes usually ahve quadratic relationships to the first
- Distances are compressed at the end of each ordination axis
- Chi-square distance measure over-emphasizes rare species

####Detrended Correspondence Analysis (DCA)
a.k.a. DECORANA. DCA is a brute-force attempt to resolve the first two issues with CA. However, the detrending used to resolve those issues can be extreme and hide patterns. The detrending also relies on arbitrary asix segmentation and twists the space which produces new artifacts.

####Nonmetric Miltidimensional Scaline (NMDS)
NMDS is a non-parametric alternative to DCA. It seeks to display the strongest structue for the data, without assuming linear relationships between variables or a Gaussian model of species distribution. It does this through an iterative search for the best position of *n* objects in *k* dimesnions that minimizes the stress of the configuration. Essentially, it moves thorugh the dimensional landscape to find the lowest spot on the landscape. In order to avoid the possibility of ending up in a local minima rather than the global minima, multiple interations of NMDS should be run.

Stress in NMDS is deined as departure from monotonicity between the dissimilarity in original space and dissimilarity in the reduced space. In other words, if the 2 or 3 dimensional representation of your data is a highly distorted representation of the original data, stress will be high. Scree plots are often used to determine the number of dimensions required to minimize stress.

![](http://www.ats.ucla.edu/stat/spss/output/spss_fa1_5.gif)

Useful for:
- Non-normal, arbitrary and discontinuous data
- Avoiding assumptions of linear relationshisp

Issues:
- Advanced computing power required (this isn't really an issue any more, but initially delayed adoption)
- Concerns about local minima

### Direct Gradient Analysis

In direct gradient analaysis, items are positioned according to measurements of environmental factors. In this way, ordination can be used to indicate the most important environmental factors in determining species composition, assuming they were measured.

Method:
- Canonical Correspondence Analysis (CCA)

####Canonical Correspondence Analysis (CCA)
CCA is commonly used in community ecology as a way to directly relate community structure to environmental variable. CCA ignores community structure and any unrelated environmental variables. 

CCA is performed by constraining the ordination of one matrix (samples or species) by multiple linear regression on variables in a second matrix (environmental variables). It uses an iterative reciprocal-averaging methos (or eigenanalysis) to provide eigenvalues and species-environment correlations.

![](http://hosho.ees.hokudai.ac.jp/~tsuyu/top/dct/stt/cca_01.png)

Useful for:
- Comarisons of species community composition to enviornmental variables
- Robust to violations of underslying assumptions of species distrubition
- Robust to multicollinearity (this is debated)

Issues:
- Assumes unimodal species response to environmental variables
- Subject to hazards of multiple regression
- Results become questionable as the ratio of environmental variables to the number of samples increases (approaches CA)
- Chi-square distance measure over-emphasizes rare species

##Example of Indrect Gradient Analysis using NMDS

*Note:* if you are using a Mac, you may need to download XQuartz before you can run some of the packages below (specifically vegan3d). https://www.xquartz.org/

The dataset used for this example is a vegetation dataset from For Irwin Army Training grounds in sand dune habitat. It includes 54 sites, consisting of 100 m transects 10 m wide. All plants along the 100 m transects were counted along with the number of fringe-toes lizards and the presence or absence of tank tracks (disturbance).

```{r}
library(vegan)
library(MASS)  
library(vegan3d)
data<-read.table("TestDataset2.csv", sep=",", header=TRUE, blank.lines.skip = TRUE)
head(data)

```
Read in a file in table format and creates a dataframe; header=indicates that the file contains the names of the variables as its first line; sep=field separator character, values on each line of the file are seperated by this character; blank.lines.skip=blank lines in the input are ignored.

```{r}
par(mfrow=c(1,3)) ##plot 3 panels above eachother
par(mar=c(3,4,1,1)+.1)  ##define margins

```

Calculate the dissimilariy matrix. In a dissimilarity matrix, the higher the value the higher the dissimilarity.  In other words the lower values indicate greater similarity between sites.

Vegdist gives the ecological dissimilarity between each pair of sites; shown for descriptive purposes as this is automatically calculated within vegan package ordinations. Bray-Curtis is default index and is good for detecting underlying ecological gradients. There are other ecologically useful indices, but Bray-Curtis is popular with community ecologists and usually not a bad choice

```{r}
d<-vegdist(data,binary="TRUE",method="bray") 
d

```

###Run Ordinations

metaMDS is VEGAN ordination function. Data is communtiy data; k is # of dimensions; distance is dissimilarity index.

####Site/Plot Ordination
```{r}
ord2site<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray") 
plot(ord2site,display="sites",main="Plot Ordination",type="t")

```

In a site or plot ordination, the points represent individual plots and those that are grouped closer to each other share similar species composition.

####Species Ordination

*Note:* the ordination results have been hidden from here on as they can be long and cumbersome to scroll through. See the results from the Site/Plot Ordination for an example.

```{r, results="hide"}
ord2spec<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
plot(ord2spec,display="species",main="Species Ordination",type="t")

```

In a species ordination, points represent indiviudal speices and those grouped together tend to co-occur on the landscape.

####Species & Site on same ordination
```{r, results="hide"}
ord2comb<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
plot(ord2comb,display=c("sites","species"),main="Combined Ordination",type="t")

```

```{r}
ord2site  
ord2spec
```

###Ordination for Data Reduction
One of the most common uses of ordination is for data reduction. Used in this way, ordination separates strong and weak patterns in multivariate data to select the most important factors. This is done by taking a data set of *n* items by *p* variables (dimensions) and trying to effectively represent the information in a smaller number of dimensions, *k*.

####Choosing Dimensions
Ordination results can be displayed in 1, 2 or 3 dimensions. In NMDS the solution may for each dimension and must be found separately.

**One Dimension**
```{r, results="hide"}
ord1site<-metaMDS(data,k=1,try=50,trymax=100,binomial=TRUE,distance="bray") 

```

```{r}
plot(ord1site,display="sites",main="1-Dimension",type="t")

```

**Two Dimensions**
```{r, results="hide"}
ord2site<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
plot(ord2site,display="sites",main="2-Dimensions",type="t")

```

**Three Dimensions**
```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray") 

```

```{r}
ordiplot3d(ord3site,display="sites",main="3-Dimensions",choices=1:3,pch=19,zlab="Dissimilarity")

```

Determining the number of axes (or dimensions) depends on the number of discrete signals that can be detected against a background of noise. The number of axes increases with more complex data sets but 2-3 are most commony used.

Stress is used to help determine the number of dimensions requied. Essentially, it is a 'badness of fit' measure based on the residuals from the non-linear regression. Stress is scored on a scale from 0 to 1 with 0 being perfect fit. There are several ways to visualize stress including Goodness of Fit plots, Shepard Stress plots, and Scree plots.

**Goodness of Fit**
```{r, results="hide"}
par(mfrow=c(1,2))
ord2site<-metaMDS(data,k=2,try=50,trymax=50,binomial=TRUE,distance="bray")

```

```{r}
gof<-goodness(ord2site)
gof 
```

Plot goodness of fit by site
```{r}
plot(ord2site,display="sites",main="2D Goodness of Fit",type="t")
points(ord2site,cex=2*gof/mean(gof))

```

Goodnes of Fit 3D
```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
gof<-goodness(ord3site)
gof
plot(ord3site,display="sites",main="3D Goodness of Fit",type="t")
points(ord3site,cex=2*gof/mean(gof))

```

**Sheppard Plots**
```{r}
stressplot(ord2site,display="sites",main="2D Shepard Stress Plot")
stressplot(ord3site,display="sites",main="3D Shepard Stress Plot")

```

How do you know the correct number of dimensions to use? The answer is subjective, and it's up to you as an ecologiest to determine what makes the most sense. Typically, ordinations are done with 2 or 3 axes. If convergence is slow you can try adding another dimension or increase the number of trys (trymax).

####Testing Hypotheses

At this point ordination axes are simply measures of dissimilarity without further ecoloigcal meaning. In order to test hypotheses, x and y axes can be correlated with enviornmental variables using biplot diagrams. 

In biplot diagrams, correlation arrows (eigenvectors) show the direction and strength of correlations between environmental variables and the ordination space. The length of the arrow is proportional to the magnitude of change in that direction and represents the strength of the relationship between the variable and community.

```{r}
lizzy<-read.table("TestHypotheses.csv", sep=",", header=TRUE, blank.lines.skip = TRUE) ##dataset with disturbance variable and lizard denstity by site
head(lizzy)

```

Does lizard density differ by site?
```{r}
liz<-envfit(ord2site ~ lizzy$LizDens, perm = 1000) 
liz<-envfit(ord2site ~ lizzy$LizDens, perm = 1000) 
liz

```

Is the disturbance significantly diffrent between sites?
```{r}
dist<-envfit(ord2site ~ lizzy$Dist, perm = 1000)
dist<-envfit(ord2site ~ lizzy$Dist, perm = 1000)
dist

```

##Biplot Diagrams

Lizard density and site
```{r}
plot(ord2site,display="site",main="Lizard Density and Site",type="t")
plot(liz, col="red", arrow.mul=(0.02/0.09)*5, label="")

```

Disturbance and site
```{r}
plot(ord2site,display="site",main="Disturbance and Site",type="t")
plot(dist, col="blue", arrow.mul=(0.02/0.09)*5, label="")

```

Lizard density and plant species
```{r}
plot(ord2site,display="species",main="Lizard Density and Plant Species",type="t")
plot(liz, col="blue", arrow.mul=(0.02/0.09)*5, label="")

```

Lizard density and disturbance
```{r}
plot(ord2site,display="species",main="Disturbance and Plant Species",type="t")
plot(dist, col="blue", arrow.mul=(0.02/0.09)*5, label="")

```


##Cluster Analysis: Hierarchic clustering

Ordination vs. classification
The main purpose of both is to interpret patterns in species composition. Classification is used for grouping ecological communities and ordination is used for arranging data along gradients. 

The vegan package allows you to overlay classification approaches (heirchical clustering) onto an ordination. The hclust function can be used to combine classification (via cluster analysis) and ordination (NMDS).

Begin by determining dissimilarities (much like ordination). vegdist gives the ecological dissimilarity between each pair of sites. Bray-Curtis is the default index and good in detecting underlying ecological gradients.
```{r}
d<-vegdist(data)  

par(mfrow=c(3,1)) ##plot 3 panels above eachother
par(mar=c(3,4,1,1)+.1)  ##define margins

```

hclust has 3 alternative clustering methods: single linkage, complete linkage and average linkage
 - Single linkage (aka nearest neighbor): the distance between 2 clusters is the shortest possible distance among members of the clusters.
 - Complete linkage (aka furthest neighbor): the default method; defines the cluster distance between two clusters to be the maximum distance between their individual componentsthe; distance between 2 clusters is the longest possible distance between the groups. 
 - Average linkage: the distance between the clusters is the distance between cluster centroids.
 
```{r, include=FALSE}
csin<-hclust(d,method="single") 
##plot dendogram, hang forces branches down to equal length
plot(csin,hang=-1,main="Single Linkage")  

```

Complete linkage clustering

```{r}
ccom<-hclust(d,method="complete") 
plot(ccom,hang=-1,main="Complete Linkage")

```

```{r,include=FALSE}
caver<-hclust(d,method="aver")  
plot(caver,hang=-1,main="Average Linkage")  

```

Run the cluster functions to produce a dendrogram or visualization of the dissimilarity matrix, based on the presence-absence data. Dendograms are visual demonstrations of the dissimilarity matrix where vertical axes show the 'fusion level,' or dissimilarity between pairs. You can determine how many classes to beak the dendrogram into, based on dissimilarity. But, again, this is a subjective call that's up to you as an ecologist.

```{r, include=FALSE}
plot(csin,hang=-1,main="Single Linkage")
rect.hclust(csin,3)

plot(ccom,hang=-1,main="Complete Linkage")
rect.hclust(ccom,3)

plot(caver,hang=-1,main="Average Linkage")
rect.hclust(caver,3)

```

##Functions for overlaying classifications onto an ordination

Overly clusters onto the ordination using convex hulls, spiter plots, and elipses.

```{r}
par(mfrow=c(1,3)) #Run and plot ordinations again
par(mar=c(3,4,1,1)+.1)  
ccom<-hclust(d,method="complete")
cl<-cutree(ccom,5)  ##cut tree into user specified # of clusters

```

Clustering overlaid on site ordinations

```{r, results="hide"}
ord2site<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray") 

```

```{r}
plot(ord2site,display="sites",main="Plot Ordination",type="t")
ordihull(ord2site,cl,lty=3)  

```

For non-overlapping classes use convex hulls

```{r, results="hide"}
ord2site<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray") 

```

```{r}
plot(ord2site,display="sites",main="Plot Ordination",type="t")
ordispider(ord2site,cl,col="blue",label=TRUE)

```

For overlapping classes use spider plot

```{r, results="hide"}
ord2site<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray") 

```

```{r}
plot(ord2site,display="sites",main="Plot Ordination",type="t")
ordiellipse(ord2site,cl,col="red") 

```

Use ellipse plot with average dispersions

##Clustering overlaid on species ordinations

```{r, results="hide"}
ord2spec<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
plot(ord2spec,display="species",main="Species Ordination",type="t")
ordihull(ord2site,cl,lty=3)

```

For non-overlapping classes use convex hulls

```{r, results="hide"}
ord2spec<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
plot(ord2spec,display="species",main="Species Ordination",type="t")
ordispider(ord2spec,cl,col="blue",label=TRUE)

```

For overlapping classes use spider plot

```{r, results="hide"}
ord2spec<-metaMDS(data,k=2,try=50,trymax=100,binomial=TRUE,distance="bray")

```


```{r}
plot(ord2spec,display="species",main="Species Ordination",type="t")
ordiellipse(ord2spec,cl,col="blue")

```

Use ellipse plot with average dispersions

## 3 Dimensional!!

Dendrograms can also be incorporated into 3 dimensional dynamic plots that allow you to visually assess the groupings. 

```{r}
library(scatterplot3d)
library(rgl)

par(mfrow=c(1,1)) 
par(mar=c(3,4,1,1)+.1)

```

orditree3d: Draw a 3D plot of dendrogram over the ordination 

```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray")
##requires ordination and hierarchic cluster analysis
```

```{r}
d<-vegdist(data)
cl<-hclust(d,"complete")
orditree3d(ord3site,cl,display="sites",type="t") 

```

Draw a dynamic 3D plot of dendrogram over the ordination where you can rotate in an RGL device

```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
d<-vegdist(data)
cl<-hclust(d,"complete")
ordirgltree(ord3site,cl,col="red",type="t",display = "site")

```

Add hierarchical clusters to RGl image

```{r, results="hide"}
caver<-hclust(d,method="aver")
cl<-cutree(caver,20)
orglellipse(ord3site,cl,col="blue",kind="ehull")

```

ordiplot3d Three-Dimensional Ordination Graphics with disturbance variable fitted

```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
ef<-envfit(ord3site~lizzy$Dist,choices=1:3)
x<-ordiplot3d(ord3site,type="n",angle=45,choices=1:3,display="site",col="red",ax.col="black",envfit=ef)
points(x,"points",pch=5,col="red",cex=0.5) ##to customize how points look, pch=different shapes, cex=size

```

type="h" is a 'pin' version of ordiplot3d

```{r, results="hide"}
ord3site<-metaMDS(data,k=3,try=50,trymax=100,binomial=TRUE,distance="bray")

```

```{r}
ef<-envfit(ord3site~lizzy$Dist,choices=1:3)
x<-ordiplot3d(ord3site,type="h",angle=45,choices=1:3,display="site",col="red",ax.col="black",envfit=ef)
points(x,"points",pch=5,col="red",cex=0.5)

```
